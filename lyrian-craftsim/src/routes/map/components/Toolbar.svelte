<script lang="ts">
  import { uiStore, selectTool, selectBiome, selectHeight, selectIcon, toggleRegionLabels, togglePOILabels, toggleHeightLabels, showModal, BIOME_TYPES } from '$lib/map/stores/uiStore';
  import { mapData, removeRegion } from '$lib/map/stores/mapStore';
  import { iconRegistry, filterIcons, filterIconsByCategory } from '$lib/map/utils/iconRegistry';
  import type { IconInfo } from '$lib/map/utils/iconRegistry';
  
  // Color mapping for biomes
  const BIOME_COLORS: Record<string, string> = {
    plains: '#91C13D',    // light green
    forest: '#2C7C30',    // dark green
    mountain: '#8B4513',  // brown
    water: '#1E90FF',     // blue
    desert: '#F4D03F',    // yellow
    swamp: '#556B2F',     // olive
    tundra: '#F0F0F0',    // white
    unexplored: '#cccccc', // gray/unexplored
  };
  
  // Height values
  const HEIGHT_OPTIONS = [0, 1, 2, 3];
  
  // Tool descriptions
  const TOOL_DESCRIPTIONS: Record<string, string> = {
    select: 'Select tiles to form regions',
    biome: 'Paint different terrain types',
    height: 'Adjust elevation of tiles',
    poi: 'Add points of interest',
    region: 'Select tiles then create or edit regions',
    icon: 'Add map icons to tiles'
  };
  
  // Icon search and filtering
  let iconSearchTerm = '';
  let filteredIcons: IconInfo[] = [];
  
  // Category selection for icons
  let activeIconCategory = 'animal';
  
  // Update filtered icons when search term or category changes
  $: {
    if (iconSearchTerm) {
      filteredIcons = filterIcons(iconRegistry, iconSearchTerm);
    } else {
      filteredIcons = filterIconsByCategory(iconRegistry, activeIconCategory);
    }
  }
  
  // Clear an icon selection
  function clearIconSelection() {
    selectIcon(null);
  }
  
  // Get current tool description
  $: toolDescription = TOOL_DESCRIPTIONS[$uiStore.currentTool] || '';
  
  // Handle tool selection
  function handleToolSelect(tool: string): void {
    selectTool(tool as any);
  }
  
  // Handle biome selection
  function handleBiomeSelect(biome: string): void {
    selectBiome(biome);
  }
  
  // Handle height selection
  function handleHeightSelect(height: number): void {
    selectHeight(height);
  }
</script>

<div class="toolbar">
  <section class="toolbar-section">
    <h3>Tools</h3>
    <div class="tools-grid">
      <button 
        class="tool-button" 
        class:active={$uiStore.currentTool === 'select'}
        on:click={() => handleToolSelect('select')}
        title="Select Tool"
      >
        <span class="tool-icon">üñ±Ô∏è</span>
        <span class="tool-label">Select</span>
      </button>
      
      <button 
        class="tool-button" 
        class:active={$uiStore.currentTool === 'biome'}
        on:click={() => handleToolSelect('biome')}
        title="Biome Paint Tool"
      >
        <span class="tool-icon">üñåÔ∏è</span>
        <span class="tool-label">Biome</span>
      </button>
      
      <button 
        class="tool-button" 
        class:active={$uiStore.currentTool === 'height'}
        on:click={() => handleToolSelect('height')}
        title="Height Tool"
      >
        <span class="tool-icon">‚õ∞Ô∏è</span>
        <span class="tool-label">Height</span>
      </button>
      
      <button 
        class="tool-button" 
        class:active={$uiStore.currentTool === 'poi'}
        on:click={() => handleToolSelect('poi')}
        title="POI Tool"
      >
        <span class="tool-icon">üìç</span>
        <span class="tool-label">POI</span>
      </button>
      
      <button 
        class="tool-button" 
        class:active={$uiStore.currentTool === 'region'}
        on:click={() => handleToolSelect('region')}
        title="Region Tool"
      >
        <span class="tool-icon">üî∑</span>
        <span class="tool-label">Region</span>
      </button>
      
      <button 
        class="tool-button" 
        class:active={$uiStore.currentTool === 'icon'}
        on:click={() => handleToolSelect('icon')}
        title="Icon Tool"
      >
        <span class="tool-icon">üè∑Ô∏è</span>
        <span class="tool-label">Icon</span>
      </button>
      
    </div>
    
    <div class="tool-description">
      {toolDescription}
    </div>
  </section>
  
  {#if $uiStore.currentTool === 'biome'}
    <section class="toolbar-section">
      <h3>Biome Types</h3>
      <div class="biome-grid">
        {#each BIOME_TYPES as biome}
          <button 
            class="biome-button" 
            class:active={$uiStore.selectedBiome === biome}
            style:background-color={BIOME_COLORS[biome]}
            on:click={() => handleBiomeSelect(biome)}
            title={biome.charAt(0).toUpperCase() + biome.slice(1)}
            aria-label={biome.charAt(0).toUpperCase() + biome.slice(1)}
          >
          </button>
        {/each}
      </div>
      <div class="selected-biome">
        Selected: {$uiStore.selectedBiome}
      </div>
    </section>
  {/if}
  
  {#if $uiStore.currentTool === 'height'}
    <section class="toolbar-section">
      <h3>Height</h3>
      <div class="height-grid">
        {#each HEIGHT_OPTIONS as height}
          <button 
            class="height-button" 
            class:active={$uiStore.selectedHeight === height}
            on:click={() => handleHeightSelect(height)}
            title={height === 0 ? 'Flat' : `Elevation ${height}`}
          >
            {height}
          </button>
        {/each}
      </div>
      <div class="selected-height">
        Selected Height: {$uiStore.selectedHeight}
      </div>
    </section>
  {/if}
  
  {#if $uiStore.currentTool === 'icon'}
    <section class="toolbar-section">
      <h3>Icon Tool</h3>
      
      <!-- Search bar -->
      <div class="search-container">
        <input 
          type="text" 
          bind:value={iconSearchTerm} 
          placeholder="Search icons..." 
          class="search-input"
        />
      </div>
      
      <!-- Category tabs -->
      <div class="category-tabs">
        {#each iconRegistry.categories as category}
          <button 
            class="category-tab"
            class:active={activeIconCategory === category.name}
            on:click={() => {
              activeIconCategory = category.name;
              iconSearchTerm = '';
            }}
          >
            {category.name}
          </button>
        {/each}
      </div>
      
      <!-- Icon grid -->
      <div class="icon-grid">
        <!-- Clear icon button -->
        <button 
          class="icon-button clear-icon"
          class:active={$uiStore.selectedIcon === null}
          on:click={clearIconSelection}
          title="No icon"
        >
          <span class="clear-icon-text">‚úï</span>
        </button>
        
        {#each filteredIcons as icon}
          <button 
            class="icon-button"
            class:active={$uiStore.selectedIcon === icon.path}
            on:click={() => selectIcon(icon.path)}
            title={icon.name}
          >
            <img src={icon.path} alt={icon.name} class="icon-preview" />
          </button>
        {/each}
      </div>
      
      {#if filteredIcons.length === 0 && iconSearchTerm}
        <div class="no-results">No icons found matching "{iconSearchTerm}"</div>
      {/if}
      
      {#if $uiStore.selectedIcon}
        <div class="selected-icon">
          <div class="selected-icon-label">Selected icon:</div>
          <div class="selected-icon-preview">
            <img src={$uiStore.selectedIcon} alt="Selected icon" class="icon-preview-large" />
          </div>
        </div>
      {:else}
        <div class="selected-icon">
          <div class="selected-icon-label">No icon selected</div>
          <div class="selected-icon-preview empty">
            <span class="no-icon">‚úï</span>
          </div>
        </div>
      {/if}
    </section>
  {/if}
  
  {#if $uiStore.currentTool === 'region'}
    <section class="toolbar-section">
      <h3>Region Tool</h3>
      <div class="region-actions">
        <button 
          class="action-button" 
          disabled={$uiStore.selectedTiles.length === 0}
          on:click={() => showModal({ type: 'region' })}
          title="Create a new region with selected tiles"
        >
          <span class="action-icon">‚ûï</span>
          <span class="action-label">Create Region</span>
        </button>
        
        <div class="selected-count">
          {$uiStore.selectedTiles.length} tiles selected
        </div>
        
        <div class="help-text">
          Select tiles then create a region
        </div>
      </div>
    </section>
    
    <!-- Region List -->
    <section class="toolbar-section">
      <h3>Existing Regions</h3>
      <div class="region-list">
        {#if $mapData.regions.size === 0}
          <div class="no-regions">No regions created yet</div>
        {:else}
          {#each Array.from($mapData.regions.values()) as region (region.id)}
            <div class="region-list-item">
              <div class="region-color" style:background-color={region.color}></div>
              <div class="region-name">{region.name}</div>
              <button 
                class="region-delete" 
                on:click={() => removeRegion(region.id)}
                title="Delete region"
              >
                üóëÔ∏è
              </button>
              <button 
                class="region-edit" 
                on:click={() => showModal({ type: 'region', regionId: region.id })}
                title="Edit region"
              >
                ‚úèÔ∏è
              </button>
            </div>
          {/each}
        {/if}
      </div>
    </section>
  {/if}
  
  <section class="toolbar-section">
    <h3>Display Options</h3>
    <div class="display-options">
      <button 
        class="option-button" 
        class:active={$uiStore.showRegionLabels}
        on:click={() => toggleRegionLabels()}
        title="Show/Hide Region Labels"
      >
        <span class="option-icon">üè∑Ô∏è</span>
        <span class="option-label">Region Labels</span>
      </button>
      
      <button 
        class="option-button" 
        class:active={$uiStore.showPOILabels}
        on:click={() => togglePOILabels()}
        title="Show/Hide POI Labels"
      >
        <span class="option-icon">üìç</span>
        <span class="option-label">POI Labels</span>
      </button>
      
      <button 
        class="option-button" 
        class:active={$uiStore.showHeightLabels}
        on:click={() => toggleHeightLabels()}
        title="Show/Hide Height Labels"
      >
        <span class="option-icon">‚õ∞Ô∏è</span>
        <span class="option-label">Height Labels</span>
      </button>
    </div>
  </section>
  
  <section class="toolbar-section instructions">
    <h3>Instructions</h3>
    <ul class="instruction-list">
      <li>Pan: Alt+Drag or Middle Mouse</li>
      <li>Zoom: Mouse Wheel</li>
      <li>Select: Click tiles</li>
      <li>Add POI: Choose POI tool and click</li>
    </ul>
  </section>
</div>

<style>
  .toolbar {
    background-color: #2a2a2a;
    color: white;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    height: 100%;
    overflow-y: auto;
  }
  
  .toolbar-section {
    border-bottom: 1px solid #444;
    padding-bottom: 1rem;
  }
  
  .toolbar-section:last-child {
    border-bottom: none;
  }
  
  h3 {
    margin-top: 0;
    margin-bottom: 0.75rem;
    font-size: 1rem;
    font-weight: 500;
    color: #ccc;
  }
  
  .tools-grid, .biome-grid, .height-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }
  
  .biome-grid {
    grid-template-columns: repeat(3, 1fr);
  }
  
  .display-options {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .tool-button, .option-button {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    background-color: #333;
    border: none;
    border-radius: 0.25rem;
    color: white;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .tool-button:hover, .option-button:hover {
    background-color: #444;
  }
  
  .tool-button.active, .option-button.active {
    background-color: #555;
    box-shadow: inset 0 0 0 2px #aaa;
  }
  
  .tool-icon, .option-icon {
    font-size: 1.25rem;
    margin-bottom: 0.25rem;
  }
  
  .tool-label, .option-label {
    font-size: 0.75rem;
  }
  
  .biome-button {
    height: 2rem;
    border: none;
    border-radius: 0.25rem;
    cursor: pointer;
    transition: transform 0.2s;
  }
  
  .biome-button:hover {
    transform: scale(1.05);
  }
  
  .biome-button.active {
    box-shadow: inset 0 0 0 3px white;
  }
  
  .height-button {
    height: 2rem;
    border: none;
    border-radius: 0.25rem;
    background-color: #333;
    color: white;
    cursor: pointer;
    font-weight: bold;
  }
  
  .height-button:hover {
    background-color: #444;
  }
  
  .height-button.active {
    background-color: #555;
    box-shadow: inset 0 0 0 2px #aaa;
  }
  
  .tool-description, .selected-biome, .selected-height, .selected-icon {
    font-size: 0.8rem;
    color: #aaa;
    text-align: center;
    margin-top: 0.5rem;
  }
  
  .instructions {
    margin-top: auto;
  }
  
  .instruction-list {
    margin: 0;
    padding-left: 1.25rem;
    font-size: 0.8rem;
    color: #aaa;
  }
  
  .instruction-list li {
    margin-bottom: 0.25rem;
  }
  
  /* Icon Styles */
  .search-container {
    margin-bottom: 0.5rem;
  }
  
  .search-input {
    width: 100%;
    padding: 0.5rem;
    background-color: #333;
    border: 1px solid #444;
    border-radius: 0.25rem;
    color: white;
  }
  
  .search-input:focus {
    outline: none;
    border-color: #666;
  }
  
  .category-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    margin-bottom: 0.5rem;
  }
  
  .category-tab {
    flex: 1;
    min-width: 40px;
    padding: 0.4rem 0.2rem;
    text-align: center;
    background-color: #333;
    border: none;
    border-radius: 0.25rem;
    color: #aaa;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .category-tab.active, .category-tab:hover {
    background-color: #444;
    color: white;
  }
  
  .icon-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0.25rem;
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: 0.5rem;
    padding-right: 0.25rem;
  }
  
  .icon-button {
    aspect-ratio: 1 / 1;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #333;
    border: 1px solid #444;
    border-radius: 0.25rem;
    cursor: pointer;
    transition: all 0.2s;
    padding: 0.25rem;
  }
  
  .icon-button:hover {
    background-color: #444;
  }
  
  .icon-button.active {
    background-color: #555;
    border-color: #aaa;
    box-shadow: 0 0 0 2px #aaa;
  }
  
  .icon-preview {
    width: 100%;
    height: 100%;
    object-fit: contain;
    filter: invert(1);
  }
  
  .clear-icon-text {
    font-size: 1.2rem;
    color: #f44336;
  }
  
  .no-results {
    text-align: center;
    font-style: italic;
    color: #888;
    margin: 1rem 0;
  }
  
  .selected-icon {
    margin-top: 0.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  .selected-icon-label {
    margin-bottom: 0.25rem;
  }
  
  .selected-icon-preview {
    width: 32px;
    height: 32px;
    background-color: #333;
    border-radius: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .selected-icon-preview.empty {
    border: 1px dashed #555;
  }
  
  .icon-preview-large {
    width: 24px;
    height: 24px;
    object-fit: contain;
    filter: invert(1);
  }
  
  .no-icon {
    color: #aaa;
    font-size: 1.2rem;
  }
  
  /* Region List Styles */
  .region-list {
    margin-top: 0.5rem;
    max-height: 200px;
    overflow-y: auto;
  }
  
  .no-regions {
    text-align: center;
    color: #aaa;
    font-size: 0.9rem;
    padding: 0.5rem;
  }
  
  .region-list-item {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    border-radius: 0.25rem;
    background-color: #333;
    margin-bottom: 0.5rem;
    gap: 0.5rem;
  }
  
  .region-color {
    width: 1rem;
    height: 1rem;
    border-radius: 0.25rem;
    flex-shrink: 0;
  }
  
  .region-name {
    flex-grow: 1;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .region-delete, .region-edit {
    background: none;
    border: none;
    padding: 0.25rem;
    cursor: pointer;
    font-size: 1rem;
    color: #aaa;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.25rem;
    transition: all 0.2s;
  }
  
  .region-delete:hover {
    color: #f44336;
    background-color: rgba(244, 67, 54, 0.1);
  }
  
  .region-edit:hover {
    color: #ffffff;
    background-color: rgba(255, 255, 255, 0.1);
  }
  
  .action-button {
    width: 100%;
    padding: 0.75rem;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 0.25rem;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }
  
  .action-button:disabled {
    background-color: #555;
    color: #888;
    cursor: not-allowed;
  }
  
  .action-button:not(:disabled):hover {
    background-color: #3e8e41;
  }
  
  .selected-count, .help-text {
    text-align: center;
    font-size: 0.85rem;
    color: #aaa;
    margin-bottom: 0.25rem;
  }
  
  .help-text {
    font-style: italic;
    color: #888;
  }
  
  .option-button {
    flex-direction: row;
    justify-content: flex-start;
    text-align: left;
    padding: 0.75rem;
    margin-bottom: 0.25rem;
  }
  
  .option-icon {
    margin-right: 0.5rem;
    margin-bottom: 0;
  }
  
  .option-label {
    font-size: 0.9rem;
  }
</style>
